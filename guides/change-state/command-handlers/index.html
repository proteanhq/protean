
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.proteanhq.com/guides/change-state/command-handlers/">
      
      
        <link rel="prev" href="../commands/">
      
      
        <link rel="next" href="../persist-aggregates/">
      
      
      <link rel="icon" href="../../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.19">
    
    
      
        <title>Command Handlers - Protean</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../../assets/external/fonts.googleapis.com/css.90ef4c13.css">
        <style>:root{--md-text-font:"Lato";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#command-handlers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Protean" class="md-header__button md-logo" aria-label="Protean" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Protean
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Command Handlers
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/proteanhq/protean" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    proteanhq/protean
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  
    
  
  Protean

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../getting-started/installation/" class="md-tabs__link">
          
  
  
    
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../core-concepts/ddd/" class="md-tabs__link">
          
  
  
    
  
  Core Concepts

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../adapters/" class="md-tabs__link">
          
  
  
    
  
  Adapters

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../patterns/" class="md-tabs__link">
          
  
  
    
  
  Patterns

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../community/" class="md-tabs__link">
          
  
  
    
  
  Community

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Protean" class="md-nav__button md-logo" aria-label="Protean" data-md-component="logo">
      
  <img src="../../../assets/logo.png" alt="logo">

    </a>
    Protean
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/proteanhq/protean" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    proteanhq/protean
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../.." class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Protean
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Essentials
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Essentials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../object-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Object Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../identity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Identity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Configuration
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Domain Model
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Domain Model
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../compose-a-domain/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Compose a Domain
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../domain-definition/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Define Concepts
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../domain-behavior/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Add Behavior
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" checked>
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    App Layer
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            App Layer
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_1" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Change State
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_4_1" id="__nav_2_4_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_4_1">
            <span class="md-nav__icon md-icon"></span>
            Change State
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../application-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Application Services
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Commands
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Command Handlers
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Command Handlers
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-facts" class="md-nav__link">
    <span class="md-ellipsis">
      Key Facts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-a-command-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Defining a Command Handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-values-from-command-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Return Values from Command Handlers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Return Values from Command Handlers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronous Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asynchronous-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Asynchronous Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-default-processing-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring Default Processing Behavior
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-of-work" class="md-nav__link">
    <span class="md-ellipsis">
      Unit of Work
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-handle_error-method" class="md-nav__link">
    <span class="md-ellipsis">
      The handle_error Method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      How It Works
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-errors-in-the-error-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Handling Errors in the Error Handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../persist-aggregates/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Persist State
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../consume-state/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Consume State Changes
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Utilities
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Utilities
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../cli/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    CLI
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../server/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Server
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    
  
  
  
    <a href="../../../core-concepts/ddd/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Core Concepts
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../adapters/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Adapters
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../patterns/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Patterns
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Glossary
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
  
    <a href="../../../community/" class="md-nav__link">
      
  
  
  <span class="md-ellipsis">
    Community
    
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#key-facts" class="md-nav__link">
    <span class="md-ellipsis">
      Key Facts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#defining-a-command-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Defining a Command Handler
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Workflow
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#return-values-from-command-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Return Values from Command Handlers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Return Values from Command Handlers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#synchronous-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Synchronous Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#asynchronous-processing" class="md-nav__link">
    <span class="md-ellipsis">
      Asynchronous Processing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuring-default-processing-behavior" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring Default Processing Behavior
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit-of-work" class="md-nav__link">
    <span class="md-ellipsis">
      Unit of Work
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      Error Handling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Error Handling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-handle_error-method" class="md-nav__link">
    <span class="md-ellipsis">
      The handle_error Method
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-it-works" class="md-nav__link">
    <span class="md-ellipsis">
      How It Works
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-errors-in-the-error-handler" class="md-nav__link">
    <span class="md-ellipsis">
      Handling Errors in the Error Handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    <span class="md-ellipsis">
      Best Practices
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="command-handlers">Command Handlers</h1>
<p>Command handlers are responsible for executing commands and persisting system
state. They typically interact with aggregate roots to perform the required
operations, ensuring that all business rules and invariants are upheld.</p>
<h2 id="key-facts">Key Facts</h2>
<ul>
<li>Command Handlers extract relevant data from a command and invoke the
appropriate aggregate method with the necessary parameters.</li>
<li>Command Handlers are responsible for hydrating (loading) and persisting
aggregates.</li>
<li>A Command Handler method can hydrate more than one aggregate at a time,
depending on the business process requirements, but it should always persist
one aggregate root. Other aggregates should be synced eventually through
domain events.</li>
</ul>
<h2 id="defining-a-command-handler">Defining a Command Handler</h2>
<p>Command Handlers are defined with the <code>Domain.command_handler</code> decorator:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timezone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">protean</span><span class="w"> </span><span class="kn">import</span> <span class="n">Domain</span><span class="p">,</span> <span class="n">handle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">protean.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">protean.utils.globals</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_domain</span>

<span class="n">publishing</span> <span class="o">=</span> <span class="n">Domain</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Publishing&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">utc_now</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArticleStatus</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">DRAFT</span> <span class="o">=</span> <span class="s2">&quot;DRAFT&quot;</span>
    <span class="n">PUBLISHED</span> <span class="o">=</span> <span class="s2">&quot;PUBLISHED&quot;</span>


<span class="hll"><span class="nd">@publishing</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="s2">&quot;Article&quot;</span><span class="p">)</span>
</span><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">PublishArticle</span><span class="p">:</span>
</span><span class="hll">    <span class="n">article_id</span> <span class="o">=</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span class="hll">    <span class="n">published_at</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">utc_now</span><span class="p">)</span>
</span>

<span class="nd">@publishing</span><span class="o">.</span><span class="n">event</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="s2">&quot;Article&quot;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ArticlePublished</span><span class="p">:</span>
    <span class="n">article_id</span> <span class="o">=</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">published_at</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">()</span>


<span class="nd">@publishing</span><span class="o">.</span><span class="n">aggregate</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">:</span>
    <span class="n">article_id</span> <span class="o">=</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">String</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">ArticleStatus</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">ArticleStatus</span><span class="o">.</span><span class="n">DRAFT</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="n">published_at</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">utc_now</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">published_at</span><span class="p">:</span> <span class="n">DateTime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">ArticleStatus</span><span class="o">.</span><span class="n">PUBLISHED</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">published_at</span> <span class="o">=</span> <span class="n">published_at</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span>
            <span class="n">ArticlePublished</span><span class="p">(</span><span class="n">article_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">article_id</span><span class="p">,</span> <span class="n">published_at</span><span class="o">=</span><span class="n">published_at</span><span class="p">)</span>
        <span class="p">)</span>


<span class="hll"><span class="nd">@publishing</span><span class="o">.</span><span class="n">command_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Article</span><span class="p">)</span>
</span><span class="hll"><span class="k">class</span><span class="w"> </span><span class="nc">ArticleCommandHandler</span><span class="p">:</span>
</span><span class="hll">    <span class="nd">@handle</span><span class="p">(</span><span class="n">PublishArticle</span><span class="p">)</span>
</span><span class="hll">    <span class="k">def</span><span class="w"> </span><span class="nf">publish_article</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
</span><span class="hll">        <span class="n">article</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Article</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">article_id</span><span class="p">)</span>
</span><span class="hll">        <span class="n">article</span><span class="o">.</span><span class="n">publish</span><span class="p">()</span>
</span><span class="hll">        <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Article</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">article</span><span class="p">)</span>
</span></code></pre></div>
<h2 id="workflow">Workflow</h2>
<pre class="mermaid"><code>sequenceDiagram
  autonumber
  App-&gt;&gt;Command Handler: Command object
  Command Handler-&gt;&gt;Command Handler: Extract data and Load aggregate
  Command Handler-&gt;&gt;Aggregate: Invoke method
  Aggregate-&gt;&gt;Aggregate: Mutate
  Aggregate--&gt;&gt;Command Handler: 
  Command Handler-&gt;&gt;Command Handler: Persist aggregate</code></pre>
<ol>
<li>
<p><strong>Domain Sends Command Object to Command Handler</strong>: The domain layer
initiates the process by sending a command object to the command handler.
This command object encapsulates the intent to perform a specific action or
operation within the domain.</p>
</li>
<li>
<p><strong>Command Handler Loads Aggregate</strong>: Upon receiving the command object, the
command handler begins by loading the necessary aggregate from the repository
or data store. The aggregate is the key entity that will be acted upon based
on the command.</p>
</li>
<li>
<p><strong>Command Handler Extracts Data and Invokes Aggregate Method</strong>: The command
handler extracts the relevant data from the command object and invokes the
appropriate method on the aggregate. This method call triggers the aggregate
to perform the specified operation.</p>
</li>
<li>
<p><strong>Aggregate Mutates</strong>: Within the aggregate, the invoked method processes
the data and performs the necessary business logic, resulting in a change
(mutation) of the aggregate's state. This ensures that the operation adheres
to the business rules and maintains consistency.</p>
</li>
<li>
<p><strong>Aggregate Responds to Command Handler</strong>: After mutating its state, the
aggregate completes its operation and returns control to the command handler.
The response may include confirmation of the successful operation or any
relevant data resulting from the mutation.</p>
</li>
<li>
<p><strong>Command Handler Persists Aggregate</strong>: Finally, the command handler
persists the modified aggregate back to the repository or data store. This
ensures that the changes made to the aggregate's state are saved and reflected
in the system's state.</p>
</li>
</ol>
<h2 id="return-values-from-command-handlers">Return Values from Command Handlers</h2>
<p>Command handlers can optionally return values to the caller when processed synchronously. This behavior is determined by how the command is processed by the domain.</p>
<h3 id="synchronous-processing">Synchronous Processing</h3>
<p>When commands are processed synchronously, the command handler's return value is passed back to the caller. This is useful for:</p>
<ul>
<li>Returning newly created resource identifiers</li>
<li>Providing validation or processing results</li>
<li>Returning calculated values or status information</li>
</ul>
<p>To process a command synchronously and receive its return value:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Process command synchronously and get the return value</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">asynchronous</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>
<p>Example of a command handler that returns a value:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">command_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Account</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AccountCommandHandler</span><span class="p">:</span>
    <span class="nd">@handle</span><span class="p">(</span><span class="n">RegisterCommand</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">RegisterCommand</span><span class="p">):</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">Account</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">command</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>

        <span class="c1"># Return the account ID for immediate use</span>
        <span class="k">return</span> <span class="n">account</span><span class="o">.</span><span class="n">id</span>
</code></pre></div>
<h3 id="asynchronous-processing">Asynchronous Processing</h3>
<p>When commands are processed asynchronously (the default behavior), the command handler's return value is not passed back to the caller. Instead, the domain's <code>process</code> method returns the position of the command in the event store:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Process command asynchronously (default)</span>
<span class="n">position</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>  <span class="c1"># or domain.process(command, asynchronous=True)</span>
</code></pre></div>
<p>In asynchronous processing, commands are handled in the background by the Protean Engine, and any return values from the command handler are ignored.</p>
<h3 id="configuring-default-processing-behavior">Configuring Default Processing Behavior</h3>
<p>The default command processing behavior can be configured in the domain's configuration:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># ...</span>
<span class="n">command_processing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;sync&quot;</span><span class="w">  </span><span class="c1"># or &quot;async&quot;</span>
<span class="c1"># ...</span>
</code></pre></div>
<p>When set to "sync", all commands will be processed synchronously by default unless explicitly specified as asynchronous, and vice versa.</p>
<h2 id="unit-of-work">Unit of Work</h2>
<p>Command handler methods always execute within a <code>UnitOfWork</code> context by
default. The UnitOfWork pattern ensures that the series of changes to an
aggregate cluster are treated as a single, atomic transaction. If an error
occurs, the UnitOfWork rolls back all changes, ensuring no partial updates
are applied.</p>
<p>Each command handler method is wrapped in a <code>UnitOfWork</code> context, without
having to explicitly specify it. Both handler methods in
<code>AccountCommandHandler</code> below are equivalent:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">protean</span><span class="w"> </span><span class="kn">import</span> <span class="n">handle</span><span class="p">,</span> <span class="n">UnitOfWork</span>


<span class="nd">@domain</span><span class="o">.</span><span class="n">command_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Account</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AccountCommandHandler</span><span class="p">:</span>
    <span class="nd">@handle</span><span class="p">(</span><span class="n">RegisterCommand</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">RegisterCommand</span><span class="p">):</span>
<span class="hll">        <span class="k">with</span> <span class="n">UnitOfWork</span><span class="p">():</span>
</span>            <span class="o">...</span>  <span class="c1"># code to register account</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">ActivateCommand</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">activate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">ActivateCommand</span><span class="p">):</span>
        <span class="o">...</span>  <span class="c1"># code to activate account</span>
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>A <code>UnitOfWork</code> context applies to objects in the aggregate cluster,
and not multiple aggregates. A Command Handler method can load multiple
aggregates to perform the business process, but should never persist more
than one at a time. Other aggregates should be synced eventually through
domain events.</p>
</div>
<h2 id="error-handling">Error Handling</h2>
<p>Command handlers support custom error handling through the optional <code>handle_error</code> method. This method is called when an exception occurs during command processing, allowing you to implement specialized error handling strategies.</p>
<h3 id="the-handle_error-method">The <code>handle_error</code> Method</h3>
<p>You can define a <code>handle_error</code> class method in your command handler to handle exceptions:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">command_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Account</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AccountCommandHandler</span><span class="p">:</span>
    <span class="nd">@handle</span><span class="p">(</span><span class="n">RegisterCommand</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">:</span> <span class="n">RegisterCommand</span><span class="p">):</span>
        <span class="c1"># Command handling logic that might raise exceptions</span>
        <span class="o">...</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom error handling logic for command processing failures&quot;&quot;&quot;</span>
        <span class="c1"># Log the error</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process command: </span><span class="si">{</span><span class="n">exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Perform recovery operations</span>
        <span class="c1"># Example: notify monitoring systems, attempt retry, etc.</span>
        <span class="o">...</span>
</code></pre></div>
<h3 id="how-it-works">How It Works</h3>
<ol>
<li>When an exception occurs in a command handler method, the Protean Engine catches it.</li>
<li>The engine logs detailed error information including stack traces.</li>
<li>The engine calls the command handler's <code>handle_error</code> method, passing:</li>
<li>The original exception that was raised</li>
<li>The command message being processed when the exception occurred</li>
<li>After <code>handle_error</code> returns, processing continues with the next command.</li>
</ol>
<h3 id="handling-errors-in-the-error-handler">Handling Errors in the Error Handler</h3>
<p>If an exception occurs within the <code>handle_error</code> method itself, the Protean Engine will catch that exception too, log it, and continue processing. This ensures that even failures in error handling don't crash the system.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">handle_error</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Potentially risky error handling logic</span>
        <span class="o">...</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">error_exc</span><span class="p">:</span>
        <span class="c1"># This secondary exception will be caught by the engine</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in error handler: </span><span class="si">{</span><span class="n">error_exc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># The engine will continue processing regardless</span>
</code></pre></div>
<h3 id="best-practices">Best Practices</h3>
<ol>
<li>Make error handlers robust and avoid complex logic that might fail.</li>
<li>Use error handlers for logging, notification, and simple recovery.</li>
<li>Don't throw exceptions from error handlers unless absolutely necessary.</li>
<li>Consider implementing retry logic for transient failures.</li>
</ol>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../commands/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Commands">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Commands
              </div>
            </div>
          </a>
        
        
          
          <a href="../persist-aggregates/" class="md-footer__link md-footer__link--next" aria-label="Next: Persist Aggregates">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Persist Aggregates
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019 - 2025 Subhash Bhushan
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>