
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://docs.proteanhq.com/patterns/idempotent-event-handlers/">
      
      
        <link rel="prev" href="../design-events-for-consumers/">
      
      
        <link rel="next" href="../event-versioning-and-evolution/">
      
      
        
      
      
      <link rel="icon" href="../../assets/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Idempotent Event Handlers - Protean</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        
        <link rel="stylesheet" href="../../assets/external/fonts.googleapis.com/css.56f7ac64.css">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#idempotent-event-handlers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Protean" class="md-header__button md-logo" aria-label="Protean" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Protean
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Idempotent Event Handlers
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/proteanhq/protean" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    proteanhq/protean
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../.." class="md-tabs__link">
          
  
  
    
  
  Protean

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guides/getting-started/installation/" class="md-tabs__link">
          
  
  
    
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../guides/" class="md-tabs__link">
          
  
  
    
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../concepts/" class="md-tabs__link">
          
  
  
    
  
  Concepts

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
  
    
  
  Patterns & Recipes

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../glossary/" class="md-tabs__link">
        
  
  
    
  
  Glossary

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../community/" class="md-tabs__link">
          
  
  
    
  
  Community

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Protean" class="md-nav__button md-logo" aria-label="Protean" data-md-component="logo">
      
  <img src="../../assets/logo.png" alt="logo">

    </a>
    Protean
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/proteanhq/protean" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    proteanhq/protean
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../.." class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Protean
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_1" id="__nav_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Protean
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../start-here/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Start Here
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Philosophy &amp; Design Principles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../contents/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contents
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-do-i/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    How Do I...?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/quickstart/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/getting-started/tutorial/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Tutorial
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorial
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_2" >
        
          
          <label class="md-nav__link" for="__nav_2_3_2" id="__nav_2_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Part I - Building the Domain
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part I - Building the Domain
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/01-your-first-aggregate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Your First Aggregate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/02-fields-and-value-objects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Rich Fields and Value Objects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/03-entities-and-associations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. Entities and Associations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/04-business-rules/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Business Rules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3_3" id="__nav_2_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Part II - Making It Event-Driven
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part II - Making It Event-Driven
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/05-commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Commands and Handlers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/06-events-and-reactions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    6. Events and Reactions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_4" >
        
          
          <label class="md-nav__link" for="__nav_2_3_4" id="__nav_2_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Part III - Read Models and Persistence
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part III - Read Models and Persistence
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/07-projections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    7. Projections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/08-persistence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    8. Connecting a Real Database
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_3_5" >
        
          
          <label class="md-nav__link" for="__nav_2_3_5" id="__nav_2_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Part IV - Testing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Part IV - Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/09-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    9. Testing Your Domain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/getting-started/tutorial/10-whats-next/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    10. What Comes Next
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/pathways/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Choose a Path
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Choose a Path
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/pathways/ddd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Domain-Driven Design with Protean
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/pathways/cqrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CQRS with Protean
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/pathways/event-sourcing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Sourcing with Protean
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/compose-a-domain/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Set Up the Domain
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Set Up the Domain
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/compose-a-domain/register-elements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Register elements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/compose-a-domain/initialize-domain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Initialize the domain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/compose-a-domain/activate-domain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Activate the domain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/compose-a-domain/when-to-compose/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    When to compose
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/domain-definition/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Model Your Domain
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Model Your Domain
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-definition/aggregates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Aggregates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-definition/entities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-definition/value-objects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Value Objects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-definition/relationships/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Expressing Relationships
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-definition/events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Events
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-definition/deciding-between-elements/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deciding Between Elements
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/domain-behavior/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Add Rules and Behavior
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Add Rules and Behavior
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-behavior/validations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Basic Validations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-behavior/invariants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Invariants
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-behavior/aggregate-mutation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Mutating Aggregates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-behavior/raising-events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Raising Events
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/domain-behavior/domain-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Domain Services
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/change-state/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Change State
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Change State
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/application-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Application Services
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/command-handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Command Handlers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/repositories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repositories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/persist-aggregates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Persist Aggregates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/retrieve-aggregates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Retrieve Aggregates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/temporal-queries/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Temporal Queries
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/change-state/unit-of-work/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unit of Work
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/consume-state/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    React to Changes
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    React to Changes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/consume-state/event-handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Handlers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/consume-state/process-managers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Managers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/consume-state/projections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Managing Projections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/consume-state/subscribers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Subscribers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/consume-state/event-upcasting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Upcasting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/fastapi/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Expose Your Domain
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Expose Your Domain
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/server/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Run the Server
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Run the Server
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../guides/testing/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Test Your Application
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_10" id="__nav_3_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Test Your Application
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/testing/domain-model-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Domain Model Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/testing/application-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Application Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/testing/event-sourcing-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Sourcing Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/testing/integration-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Integration Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/testing/fixtures-and-patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fixtures and Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/domain-elements/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Domain Elements
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Domain Elements
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/domain-elements/element-decorators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Decorators
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/domain-elements/object-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Object Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/domain-elements/identity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Identity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/fields/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Fields
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Fields
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/fields/defining-fields/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Defining fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/fields/simple-fields/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Simple Fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/fields/container-fields/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Container Fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/fields/association-fields/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Association Fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/fields/arguments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Common Arguments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/configuration/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Configuration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/cli/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_5" id="__nav_4_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    CLI
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/cli/project/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Project
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_5_2" id="__nav_4_5_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Project
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/project/new/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean new
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/project/discovery/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Domain Discovery
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/project/shell/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean shell
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/project/docs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean docs
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/cli/runtime/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Runtime
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_5_3" id="__nav_4_5_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Runtime
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/runtime/server/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/runtime/observatory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean observatory
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_5_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/cli/data/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Data
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_5_4" id="__nav_4_5_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/data/database/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean db
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/data/events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean events
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/data/snapshot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean snapshot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/cli/data/projection/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    protean projection
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/server/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Server
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_6" id="__nav_4_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Server
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/server/subscription-types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Subscription Types
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/server/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Subscription Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/server/supervisor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Worker Mode
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/server/observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Observability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/adapters/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Adapters
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_7" id="__nav_4_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Adapters
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/adapters/database/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Database
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_7_2" id="__nav_4_7_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_7_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Database
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/database/postgresql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PostgreSQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/database/elasticsearch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Elasticsearch
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/adapters/broker/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Brokers
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_7_3" id="__nav_4_7_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Brokers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/broker/inline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Inline Broker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/broker/redis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis Stream Broker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/broker/redis-pubsub/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis PubSub Broker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/broker/custom-brokers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Brokers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/adapters/cache/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Caches
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_7_4" id="__nav_4_7_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_7_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Caches
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/cache/redis/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Redis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_7_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/adapters/eventstore/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Event Stores
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_7_5" id="__nav_4_7_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_4_7_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_7_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Event Stores
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/adapters/eventstore/message-db/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Message DB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/type-checking/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Type Checking
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Type Checking
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_9" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/testing/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Testing
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_9" id="__nav_4_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/testing/pytest-plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pytest Plugin
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_10" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/migration/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Migration
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Migration
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/migration/v0-15/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Migrating to 0.15
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Concepts
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/philosophy/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Philosophy & Principles
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Philosophy & Principles
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_3" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/foundations/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Foundations
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_3" id="__nav_5_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Foundations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/foundations/ubiquitous-language/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Ubiquitous Language
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/foundations/bounded-contexts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bounded Contexts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/foundations/analysis-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Analysis Model
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/foundations/identity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Identity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/foundations/invariants/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Invariants
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/foundations/changing-state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Changing State
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/foundations/streams/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Streams
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_4" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/architecture/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Architecture Patterns
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_4" id="__nav_5_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture Patterns
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/architecture/ddd/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    DDD
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/architecture/cqrs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CQRS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/architecture/event-sourcing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Sourcing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/architecture/architecture-decision/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Choosing Between Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_5" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/building-blocks/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Building Blocks
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_5" id="__nav_5_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Building Blocks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/aggregates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Aggregates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/entities/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Entities
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/value-objects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Value Objects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/domain-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Domain Services
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/events/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Events
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/commands/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Commands
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/command-handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Command Handlers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/event-handlers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Handlers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/application-services/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Application Services
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/repositories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Repositories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/subscribers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Subscribers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/projections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Projections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/projectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Projectors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/building-blocks/process-managers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Process Managers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_6" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/async-processing/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Async Processing
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_6" id="__nav_5_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Async Processing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/async-processing/engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Engine Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/async-processing/subscriptions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Subscriptions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/async-processing/outbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Outbox Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/async-processing/priority-lanes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Priority Lanes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/async-processing/stream-categories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stream Categories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_7" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/ports-and-adapters/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Ports & Adapters
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ports & Adapters
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../concepts/internals/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Internals
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_8" id="__nav_5_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Internals
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/internals/field-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Field system
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/internals/shadow-fields/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Shadow fields
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/internals/query-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Query system
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/internals/event-sourcing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Sourcing Internals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/internals/event-upcasting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Upcasting Internals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Patterns & Recipes
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Patterns & Recipes
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_2" >
        
          
          <label class="md-nav__link" for="__nav_6_2" id="__nav_6_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Aggregate Design
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Aggregate Design
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design-small-aggregates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Small Aggregates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../one-aggregate-per-transaction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    One Aggregate Per Transaction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../encapsulate-state-changes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Encapsulate State Changes in Named Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../replace-primitives-with-value-objects/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Replace Primitives with Value Objects
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6_3" checked>
        
          
          <label class="md-nav__link" for="__nav_6_3" id="__nav_6_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Event-Driven Patterns
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Event-Driven Patterns
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../design-events-for-consumers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Design Events for Consumers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Idempotent Event Handlers
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Idempotent Event Handlers
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Problem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Pattern
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events-vs-commands-why-handlers-differ" class="md-nav__link">
    <span class="md-ellipsis">
      
        Events vs Commands: Why Handlers Differ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategy-1-naturally-idempotent-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Strategy 1: Naturally Idempotent Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 1: Naturally Idempotent Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-based-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Set-Based Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-prefer-set-based-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Prefer Set-Based Design
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategy-2-deduplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Strategy 2: Deduplication
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 2: Deduplication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-before-act" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check-Before-Act
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#track-processed-event-ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        Track Processed Event IDs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-event-sequence-numbers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Use Event Sequence Numbers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategy-3-upsert-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Strategy 3: Upsert Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 3: Upsert Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#projector-upserts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Projector Upserts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-machine-guard" class="md-nav__link">
    <span class="md-ellipsis">
      
        State Machine Guard
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applying-the-pattern-worked-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Applying the Pattern: Worked Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applying the Pattern: Worked Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-loyalty-points-additive-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 1: Loyalty Points (Additive Operation)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-inventory-reservation-cross-aggregate-side-effect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 2: Inventory Reservation (Cross-Aggregate Side Effect)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-notification-external-side-effect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 3: Notification (External Side Effect)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-handler-vs-projector-idempotency" class="md-nav__link">
    <span class="md-ellipsis">
      
        Event Handler vs Projector Idempotency
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Event Handler vs Projector Idempotency">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#projectors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Projectors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Event Handlers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#when-perfect-idempotency-is-impractical" class="md-nav__link">
    <span class="md-ellipsis">
      
        When Perfect Idempotency Is Impractical
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="When Perfect Idempotency Is Impractical">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#time-dependent-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time-Dependent Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-api-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        External API Calls
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signs-your-handler-isnt-idempotent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Signs Your Handler Isn't Idempotent
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event-versioning-and-evolution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Event Versioning and Evolution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../command-idempotency/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Command Idempotency
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../coordinating-long-running-processes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coordinating Long-Running Processes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_4" >
        
          
          <label class="md-nav__link" for="__nav_6_4" id="__nav_6_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture & Quality
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture & Quality
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../organize-by-domain-concept/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Organize by Domain Concept
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation-layering/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Validation Layering
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../thin-handlers-rich-domain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thin Handlers, Rich Domain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../testing-domain-logic-in-isolation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing Domain Logic in Isolation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_5" >
        
          
          <label class="md-nav__link" for="__nav_6_5" id="__nav_6_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Identity & Communication
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Identity & Communication
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../creating-identities-early/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Creating Identities Early
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../connect-concepts-across-domains/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connecting Concepts Across Bounded Contexts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../consuming-events-from-other-domains/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Consuming Events from Other Domains
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sharing-event-classes-across-domains/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Sharing Event Classes Across Domains
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6_6" >
        
          
          <label class="md-nav__link" for="__nav_6_6" id="__nav_6_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Testing & Infrastructure
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Testing & Infrastructure
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dual-mode-testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dual-Mode Testing with Memory and Real Adapters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../setting-up-and-tearing-down-database-for-tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setting Up and Tearing Down Databases for Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../running-migration-with-priority-lanes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running Migrations Without Blocking Production
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../community/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Community
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Community
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/quality/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quality Report
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/contributing/setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Setting up Protean locally
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/contributing/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing Protean
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../community/contributing/adapters/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building Adapters
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-problem" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Problem
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        The Pattern
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events-vs-commands-why-handlers-differ" class="md-nav__link">
    <span class="md-ellipsis">
      
        Events vs Commands: Why Handlers Differ
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategy-1-naturally-idempotent-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Strategy 1: Naturally Idempotent Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 1: Naturally Idempotent Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set-based-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Set-Based Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#when-to-prefer-set-based-design" class="md-nav__link">
    <span class="md-ellipsis">
      
        When to Prefer Set-Based Design
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategy-2-deduplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        Strategy 2: Deduplication
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 2: Deduplication">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#check-before-act" class="md-nav__link">
    <span class="md-ellipsis">
      
        Check-Before-Act
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#track-processed-event-ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        Track Processed Event IDs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#use-event-sequence-numbers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Use Event Sequence Numbers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#strategy-3-upsert-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Strategy 3: Upsert Operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Strategy 3: Upsert Operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#projector-upserts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Projector Upserts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-machine-guard" class="md-nav__link">
    <span class="md-ellipsis">
      
        State Machine Guard
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#applying-the-pattern-worked-examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Applying the Pattern: Worked Examples
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applying the Pattern: Worked Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#example-1-loyalty-points-additive-operation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 1: Loyalty Points (Additive Operation)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-2-inventory-reservation-cross-aggregate-side-effect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 2: Inventory Reservation (Cross-Aggregate Side Effect)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example-3-notification-external-side-effect" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example 3: Notification (External Side Effect)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#event-handler-vs-projector-idempotency" class="md-nav__link">
    <span class="md-ellipsis">
      
        Event Handler vs Projector Idempotency
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Event Handler vs Projector Idempotency">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#projectors" class="md-nav__link">
    <span class="md-ellipsis">
      
        Projectors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-handlers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Event Handlers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#when-perfect-idempotency-is-impractical" class="md-nav__link">
    <span class="md-ellipsis">
      
        When Perfect Idempotency Is Impractical
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="When Perfect Idempotency Is Impractical">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#time-dependent-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Time-Dependent Operations
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-api-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        External API Calls
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#signs-your-handler-isnt-idempotent" class="md-nav__link">
    <span class="md-ellipsis">
      
        Signs Your Handler Isn't Idempotent
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Summary
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                




  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../" class="md-path__link">
          
  <span class="md-ellipsis">
    Patterns & Recipes
  </span>

        </a>
      </li>
    
  

      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../design-events-for-consumers/" class="md-path__link">
          
  <span class="md-ellipsis">
    Event-Driven Patterns
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="idempotent-event-handlers">Idempotent Event Handlers</h1>
<h2 id="the-problem">The Problem</h2>
<p>An event handler processes <code>OrderPlaced</code> events and awards loyalty points:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">CustomerLoyalty</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LoyaltyEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">award_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">CustomerLoyalty</span><span class="p">)</span>
        <span class="n">loyalty</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
        <span class="n">loyalty</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">loyalty</span><span class="p">)</span>
</code></pre></div>
<p>In production, the Protean server processes events from the event store via
subscriptions. The subscription tracks its position in the stream, advancing
as events are processed. But the server crashes between processing the event
and persisting the updated position. On restart, the subscription resumes from
its last saved position -- and delivers the same <code>OrderPlaced</code> event again.</p>
<p>The handler runs a second time. The customer gets double loyalty points.</p>
<p>This is not a rare edge case. It happens routinely in distributed systems:</p>
<ul>
<li>
<p><strong>Server restart during processing.</strong> The event was handled, the aggregate
  was persisted, but the subscription position wasn't updated before the crash.</p>
</li>
<li>
<p><strong>Broker redelivery.</strong> The message broker delivered the event, but the
  consumer didn't acknowledge it before disconnecting. The broker redelivers.</p>
</li>
<li>
<p><strong>Subscription replay.</strong> A subscription is restarted from an earlier position
  for debugging, migration, or recovery.</p>
</li>
<li>
<p><strong>Network partitions.</strong> The handler commits to the database but the
  acknowledgment to the event store is lost. The event is redelivered.</p>
</li>
<li>
<p><strong>Competing consumers.</strong> In a multi-instance deployment, two instances
  briefly process the same event before coordination kicks in.</p>
</li>
</ul>
<p>Unlike commands (covered in <a href="../command-idempotency/">Command Idempotency</a>),
events represent <strong>facts that already happened</strong>. You cannot reject an event or
return an error to its producer. The Order was placed. The handler must deal
with it -- potentially more than once.</p>
<hr />
<h2 id="the-pattern">The Pattern</h2>
<p>Design every event handler to produce the <strong>same result</strong> whether it processes
an event once or multiple times. The aggregate's state after two deliveries
should be identical to its state after one.</p>
<p>This is achieved through one of three strategies:</p>
<ol>
<li><strong>Naturally idempotent operations</strong> -- operations that produce the same
   result regardless of repetition (set-based, not additive).</li>
<li><strong>Deduplication</strong> -- detecting and skipping duplicate deliveries.</li>
<li><strong>Upsert instead of insert</strong> -- using database semantics that handle
   duplicates gracefully.</li>
</ol>
<hr />
<h2 id="events-vs-commands-why-handlers-differ">Events vs Commands: Why Handlers Differ</h2>
<p>The <a href="../command-idempotency/">Command Idempotency</a> pattern covers framework-level
deduplication for commands using idempotency keys and Redis-backed caches.
Event handlers have different characteristics:</p>
<table>
<thead>
<tr>
<th>Aspect</th>
<th>Commands</th>
<th>Events</th>
</tr>
</thead>
<tbody>
<tr>
<td>Semantics</td>
<td>Intent to change</td>
<td>Fact that occurred</td>
</tr>
<tr>
<td>Can be rejected?</td>
<td>Yes</td>
<td>No (it already happened)</td>
</tr>
<tr>
<td>Idempotency key</td>
<td>Caller-provided</td>
<td>Not applicable</td>
</tr>
<tr>
<td>Framework dedup</td>
<td>Redis-backed cache (Layers 1-2)</td>
<td>Subscription position only</td>
</tr>
<tr>
<td>Handler responsibility</td>
<td>Defense-in-depth</td>
<td>Primary defense</td>
</tr>
</tbody>
</table>
<p>Because events don't carry caller-provided idempotency keys, the handler itself
is the primary defense against duplicate processing. The subscription's position
tracking provides some protection, but it's not sufficient (position updates
are periodic, not per-message).</p>
<hr />
<h2 id="strategy-1-naturally-idempotent-operations">Strategy 1: Naturally Idempotent Operations</h2>
<p>The simplest and most robust approach. If the handler's operation produces the
same result whether executed once or ten times, duplicates are harmless.</p>
<h3 id="set-based-operations">Set-Based Operations</h3>
<p>Operations that <strong>set</strong> state rather than <strong>add</strong> to it are naturally idempotent:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">OrderStatus</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderStatusEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderShipped</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_order_shipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderShipped</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">OrderStatus</span><span class="p">)</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="c1"># Setting status to &quot;shipped&quot; is idempotent</span>
        <span class="c1"># Doing it twice produces the same result</span>
        <span class="n">status</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;shipped&quot;</span>
        <span class="n">status</span><span class="o">.</span><span class="n">shipped_at</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">shipped_at</span>
        <span class="n">status</span><span class="o">.</span><span class="n">tracking_number</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">tracking_number</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
</code></pre></div>
<p>Setting <code>status = "shipped"</code> ten times leaves the status at "shipped". There's
no accumulation, no duplication, no corruption.</p>
<p><strong>More naturally idempotent patterns:</strong></p>
<ul>
<li>Replacing a value: <code>user.email = event.new_email</code></li>
<li>Overwriting a flag: <code>order.is_paid = True</code></li>
<li>Assigning a reference: <code>task.assignee_id = event.user_id</code></li>
<li>Replacing a value object: <code>account.address = Address(...)</code></li>
</ul>
<h3 id="when-to-prefer-set-based-design">When to Prefer Set-Based Design</h3>
<p>If you can design your event handler to use set-based operations instead of
additive ones, always do so. It eliminates the need for deduplication
entirely.</p>
<p>For example, instead of incrementing a counter:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Additive (NOT idempotent)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">order_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">total_revenue</span> <span class="o">+=</span> <span class="n">event</span><span class="o">.</span><span class="n">total</span>
</code></pre></div>
<p>Consider maintaining the full state:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Set-based (idempotent)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
    <span class="c1"># Recalculate from the projection&#39;s stored orders</span>
    <span class="n">stats</span><span class="o">.</span><span class="n">record_order</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">total</span><span class="p">)</span>
    <span class="c1"># record_order uses a set: adding the same order_id twice is a no-op</span>
</code></pre></div>
<hr />
<h2 id="strategy-2-deduplication">Strategy 2: Deduplication</h2>
<p>When the operation is inherently additive (incrementing counters, appending
to lists, creating new records), you need explicit deduplication.</p>
<h3 id="check-before-act">Check-Before-Act</h3>
<p>The simplest deduplication: check whether the event has already been processed
before processing it.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">InventoryEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">reserve_inventory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Inventory</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">inventory</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;product_id&quot;</span><span class="p">])</span>

            <span class="c1"># Check if this event&#39;s reservation was already applied</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">order_id</span> <span class="ow">in</span> <span class="n">inventory</span><span class="o">.</span><span class="n">reserved_for_orders</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Already processed, skip</span>

            <span class="n">inventory</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span>
                <span class="n">quantity</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
                <span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span>
</code></pre></div>
<p>The <code>Inventory</code> aggregate tracks which orders have already reserved stock.
If the same <code>OrderPlaced</code> event arrives twice, the second delivery finds the
order ID already in the set and skips.</p>
<h3 id="track-processed-event-ids">Track Processed Event IDs</h3>
<p>For handlers that process many event types, maintain a set of processed event
identifiers:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">CustomerLoyalty</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LoyaltyEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">award_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">CustomerLoyalty</span><span class="p">)</span>
        <span class="n">loyalty</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>

        <span class="c1"># Use the event&#39;s unique ID for deduplication</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">event_id</span> <span class="ow">in</span> <span class="n">loyalty</span><span class="o">.</span><span class="n">processed_events</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Already processed</span>

        <span class="n">loyalty</span><span class="o">.</span><span class="n">add_points</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">total</span><span class="p">))</span>
        <span class="n">loyalty</span><span class="o">.</span><span class="n">processed_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">loyalty</span><span class="p">)</span>
</code></pre></div>
<p>The <code>processed_events</code> list is a bounded collection of recently processed
event IDs. For high-volume aggregates, prune entries older than a retention
window (e.g., keep only the last 1000 or entries from the last 24 hours).</p>
<h3 id="use-event-sequence-numbers">Use Event Sequence Numbers</h3>
<p>When events come from a stream with guaranteed ordering, the stream position
itself can serve as a deduplication marker:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">ProjectionState</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ProjectionStateHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">ProjectionState</span><span class="p">)</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;order-projection&quot;</span><span class="p">)</span>

        <span class="c1"># Use stream position for deduplication</span>
        <span class="n">event_position</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">sequence</span>
        <span class="k">if</span> <span class="n">event_position</span> <span class="o">&lt;=</span> <span class="n">state</span><span class="o">.</span><span class="n">last_processed_position</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Already processed or older</span>

        <span class="c1"># Process the event</span>
        <span class="n">state</span><span class="o">.</span><span class="n">apply_order_placed</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
        <span class="n">state</span><span class="o">.</span><span class="n">last_processed_position</span> <span class="o">=</span> <span class="n">event_position</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</code></pre></div>
<p>This is particularly useful for projectors that rebuild from an event stream
and need to track their position.</p>
<hr />
<h2 id="strategy-3-upsert-operations">Strategy 3: Upsert Operations</h2>
<p>For handlers that create new records (like projections), use upsert semantics
to handle duplicates at the database level.</p>
<h3 id="projector-upserts">Projector Upserts</h3>
<p>Projectors are a common case where idempotency matters. When a projector
processes <code>OrderPlaced</code> to create an <code>OrderSummary</code> projection, a duplicate
delivery would try to create a second record with the same ID:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">projector</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">OrderSummaryProjection</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderSummaryProjector</span><span class="p">(</span><span class="n">BaseProjector</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">OrderSummaryProjection</span><span class="p">)</span>

        <span class="c1"># Check if the projection already exists</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
            <span class="c1"># Already created -- update instead of insert</span>
            <span class="n">existing</span><span class="o">.</span><span class="n">customer_name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_name</span>
            <span class="n">existing</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">total</span>
            <span class="n">existing</span><span class="o">.</span><span class="n">placed_at</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">placed_at</span>
            <span class="n">existing</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;placed&quot;</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">existing</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># First time -- create</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">OrderSummaryProjection</span><span class="p">(</span>
                <span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
                <span class="n">customer_name</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">customer_name</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;placed&quot;</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">total</span><span class="p">,</span>
                <span class="n">placed_at</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">placed_at</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
</code></pre></div>
<p>This pattern naturally handles both first delivery and duplicate delivery. The
result is the same either way.</p>
<h3 id="state-machine-guard">State Machine Guard</h3>
<p>For handlers that trigger state transitions, use the aggregate's current state
as a guard:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Shipment</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ShipmentEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPaid</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_shipment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPaid</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Shipment</span><span class="p">)</span>

        <span class="c1"># Check if a shipment already exists for this order</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">find_by_order_id</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Shipment already created</span>

        <span class="n">shipment</span> <span class="o">=</span> <span class="n">Shipment</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">customer_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
            <span class="n">items</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
            <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">shipment</span><span class="p">)</span>
</code></pre></div>
<hr />
<h2 id="applying-the-pattern-worked-examples">Applying the Pattern: Worked Examples</h2>
<h3 id="example-1-loyalty-points-additive-operation">Example 1: Loyalty Points (Additive Operation)</h3>
<p>Loyalty points are additive -- awarding points twice doubles the reward.
This requires explicit deduplication.</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">aggregate</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CustomerLoyalty</span><span class="p">:</span>
    <span class="n">customer_id</span><span class="p">:</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">points</span><span class="p">:</span> <span class="n">Integer</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">point_transactions</span> <span class="o">=</span> <span class="n">HasMany</span><span class="p">(</span><span class="n">PointTransaction</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">award_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Award loyalty points for an order, idempotently.&quot;&quot;&quot;</span>
        <span class="c1"># Check if points were already awarded for this order</span>
        <span class="k">for</span> <span class="n">txn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_transactions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">txn</span><span class="o">.</span><span class="n">source_id</span> <span class="o">==</span> <span class="n">order_id</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># Already awarded</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">points</span> <span class="o">+=</span> <span class="n">amount</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_transactions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">PointTransaction</span><span class="p">(</span>
            <span class="n">source_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">amount</span><span class="o">=</span><span class="n">amount</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;earned&quot;</span><span class="p">,</span>
        <span class="p">))</span>


<span class="nd">@domain</span><span class="o">.</span><span class="n">entity</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">CustomerLoyalty</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PointTransaction</span><span class="p">:</span>
    <span class="n">source_id</span><span class="p">:</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">amount</span><span class="p">:</span> <span class="n">Integer</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">CustomerLoyalty</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LoyaltyEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">award_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">CustomerLoyalty</span><span class="p">)</span>
        <span class="n">loyalty</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
        <span class="c1"># The aggregate method handles idempotency internally</span>
        <span class="n">loyalty</span><span class="o">.</span><span class="n">award_points</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">amount</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">total</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">loyalty</span><span class="p">)</span>
</code></pre></div>
<p>The idempotency logic lives in the aggregate's <code>award_points</code> method, not
in the handler. The handler is thin. The aggregate checks its
<code>point_transactions</code> to detect duplicates.</p>
<h3 id="example-2-inventory-reservation-cross-aggregate-side-effect">Example 2: Inventory Reservation (Cross-Aggregate Side Effect)</h3>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">aggregate</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Inventory</span><span class="p">:</span>
    <span class="n">product_id</span><span class="p">:</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">available_quantity</span><span class="p">:</span> <span class="n">Integer</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">reservations</span> <span class="o">=</span> <span class="n">HasMany</span><span class="p">(</span><span class="n">Reservation</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reserve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">quantity</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reserve inventory for an order, idempotently.&quot;&quot;&quot;</span>
        <span class="c1"># Check if already reserved for this order</span>
        <span class="k">for</span> <span class="n">reservation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reservations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reservation</span><span class="o">.</span><span class="n">order_id</span> <span class="o">==</span> <span class="n">order_id</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># Already reserved</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">&lt;</span> <span class="n">quantity</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;quantity&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient inventory. Available: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">available_quantity</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">]}</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">available_quantity</span> <span class="o">-=</span> <span class="n">quantity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reservations</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Reservation</span><span class="p">(</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
        <span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">raise_</span><span class="p">(</span><span class="n">InventoryReserved</span><span class="p">(</span>
            <span class="n">product_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">product_id</span><span class="p">,</span>
            <span class="n">order_id</span><span class="o">=</span><span class="n">order_id</span><span class="p">,</span>
            <span class="n">quantity</span><span class="o">=</span><span class="n">quantity</span><span class="p">,</span>
        <span class="p">))</span>


<span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Inventory</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">InventoryEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Inventory</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">event</span><span class="o">.</span><span class="n">items</span><span class="p">:</span>
            <span class="n">inventory</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;product_id&quot;</span><span class="p">])</span>
            <span class="n">inventory</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span>
                <span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span>
                <span class="n">quantity</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;quantity&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">inventory</span><span class="p">)</span>
</code></pre></div>
<p>The <code>Reservation</code> entity within the <code>Inventory</code> aggregate acts as a
deduplication record. The <code>order_id</code> on each reservation uniquely identifies
the source event, making the operation idempotent.</p>
<h3 id="example-3-notification-external-side-effect">Example 3: Notification (External Side Effect)</h3>
<p>External side effects (sending emails, calling APIs) require special care
because they cannot be rolled back:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">aggregate</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Notification</span><span class="p">:</span>
    <span class="n">notification_id</span><span class="p">:</span> <span class="n">Auto</span><span class="p">(</span><span class="n">identifier</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">recipient_id</span><span class="p">:</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">source_event_id</span><span class="p">:</span> <span class="n">Identifier</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">)</span>
    <span class="n">sent_at</span><span class="p">:</span> <span class="n">DateTime</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">mark_sent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;sent&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sent_at</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>


<span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Notification</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NotificationEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Notification</span><span class="p">)</span>

        <span class="c1"># Use event ID as the deduplication key</span>
        <span class="n">event_id</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">_metadata</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">id</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">find_by_source_event_id</span><span class="p">(</span><span class="n">event_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">existing</span> <span class="ow">and</span> <span class="n">existing</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;sent&quot;</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Already sent</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="p">:</span>
            <span class="n">notification</span> <span class="o">=</span> <span class="n">Notification</span><span class="p">(</span>
                <span class="n">recipient_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;order_confirmation&quot;</span><span class="p">,</span>
                <span class="n">source_event_id</span><span class="o">=</span><span class="n">event_id</span><span class="p">,</span>
                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">notification</span><span class="p">)</span>

        <span class="c1"># The actual sending happens via the outbox pattern</span>
        <span class="c1"># or a separate process that picks up pending notifications</span>
</code></pre></div>
<p>Instead of sending the email directly (which can't be undone), the handler
creates a <code>Notification</code> record. A separate process sends pending notifications
and marks them as sent. If the event is redelivered, the handler finds the
existing notification and skips.</p>
<hr />
<h2 id="event-handler-vs-projector-idempotency">Event Handler vs Projector Idempotency</h2>
<p>Projectors and event handlers have different idempotency characteristics:</p>
<h3 id="projectors">Projectors</h3>
<p>Projectors maintain read-optimized projections. They're typically idempotent
by nature because they <strong>set</strong> the projection's state rather than accumulate it:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">projector</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">OrderDashboardProjection</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">OrderDashboardProjector</span><span class="p">(</span><span class="n">BaseProjector</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderPlaced</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">OrderDashboardProjection</span><span class="p">)</span>
        <span class="c1"># Upsert pattern: create or update</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">projection</span><span class="p">:</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="n">OrderDashboardProjection</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>

        <span class="n">projection</span><span class="o">.</span><span class="n">customer_name</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">customer_name</span>
        <span class="n">projection</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;placed&quot;</span>
        <span class="n">projection</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">total</span>
        <span class="n">projection</span><span class="o">.</span><span class="n">placed_at</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">placed_at</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">OrderShipped</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">on_order_shipped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderShipped</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">OrderDashboardProjection</span><span class="p">)</span>
        <span class="n">projection</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">projection</span><span class="p">:</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;shipped&quot;</span>
            <span class="n">projection</span><span class="o">.</span><span class="n">shipped_at</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">shipped_at</span>
            <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
</code></pre></div>
<p>Each handler sets fields to specific values. Processing the same event twice
produces the same projection state.</p>
<h3 id="event-handlers">Event Handlers</h3>
<p>Event handlers that modify domain aggregates need more care because aggregates
have business rules, invariants, and state machines:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@domain</span><span class="o">.</span><span class="n">event_handler</span><span class="p">(</span><span class="n">part_of</span><span class="o">=</span><span class="n">Account</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AccountEventHandler</span><span class="p">(</span><span class="n">BaseEventHandler</span><span class="p">):</span>

    <span class="nd">@handle</span><span class="p">(</span><span class="n">MoneyDebited</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">credit_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">MoneyDebited</span><span class="p">):</span>
        <span class="n">repo</span> <span class="o">=</span> <span class="n">current_domain</span><span class="o">.</span><span class="n">repository_for</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">target_account_id</span><span class="p">)</span>

        <span class="c1"># Must deduplicate because credit is additive</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">transfer_id</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">processed_transfers</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">target</span><span class="o">.</span><span class="n">credit</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">amount</span><span class="p">)</span>
        <span class="n">target</span><span class="o">.</span><span class="n">processed_transfers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">transfer_id</span><span class="p">)</span>
        <span class="n">repo</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</code></pre></div>
<p>The key difference: projectors typically use set-based operations (naturally
idempotent), while event handlers often perform additive operations (require
explicit deduplication).</p>
<hr />
<h2 id="when-perfect-idempotency-is-impractical">When Perfect Idempotency Is Impractical</h2>
<p>Some scenarios make perfect idempotency difficult:</p>
<h3 id="time-dependent-operations">Time-Dependent Operations</h3>
<p>If the handler's behavior depends on the current time, two executions at
different times may produce different results:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
    <span class="c1"># This is NOT idempotent -- running at different times changes the result</span>
    <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">event</span><span class="o">.</span><span class="n">placed_at</span> <span class="o">&gt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">flag_as_delayed</span><span class="p">()</span>
</code></pre></div>
<p>Mitigation: use the event's timestamp, not the current time, for time-dependent
decisions:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
    <span class="c1"># Better: use event time, not wall clock</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">expected_delivery_date</span> <span class="o">&lt;</span> <span class="n">event</span><span class="o">.</span><span class="n">placed_at</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">):</span>
        <span class="n">order</span><span class="o">.</span><span class="n">flag_as_delayed</span><span class="p">()</span>
</code></pre></div>
<h3 id="external-api-calls">External API Calls</h3>
<p>If the handler calls an external API that's not idempotent, duplicate
processing produces duplicate external effects:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">on_order_placed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">OrderPlaced</span><span class="p">):</span>
    <span class="c1"># NOT idempotent -- sends duplicate SMS on redelivery</span>
    <span class="n">sms_service</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">customer_phone</span><span class="p">,</span> <span class="s2">&quot;Your order is confirmed!&quot;</span><span class="p">)</span>
</code></pre></div>
<p>Mitigation: use the status flag pattern (track whether the side effect
occurred) or the outbox pattern (create a record, send asynchronously with
deduplication).</p>
<hr />
<h2 id="signs-your-handler-isnt-idempotent">Signs Your Handler Isn't Idempotent</h2>
<ol>
<li>
<p><strong>Counter increments.</strong> <code>stats.count += 1</code> is not idempotent.</p>
</li>
<li>
<p><strong>List appends without checking.</strong> <code>items.append(new_item)</code> without
   checking if the item is already present.</p>
</li>
<li>
<p><strong>Creating records without existence checks.</strong> <code>repo.add(new_record)</code>
   without checking if a record for this event already exists.</p>
</li>
<li>
<p><strong>Direct external API calls.</strong> Sending emails, SMS, or API requests
   without deduplication.</p>
</li>
<li>
<p><strong>Generating new identifiers.</strong> If the handler creates a new aggregate
   with <code>Auto(identifier=True)</code>, a duplicate delivery creates a second
   aggregate with a different ID.</p>
</li>
</ol>
<hr />
<h2 id="summary">Summary</h2>
<table>
<thead>
<tr>
<th>Strategy</th>
<th>When to Use</th>
<th>Complexity</th>
<th>Robustness</th>
</tr>
</thead>
<tbody>
<tr>
<td>Set-based operations</td>
<td>Handler sets state, doesn't accumulate</td>
<td>Low</td>
<td>High</td>
</tr>
<tr>
<td>Check-before-act</td>
<td>Additive operations, moderate volume</td>
<td>Medium</td>
<td>High</td>
</tr>
<tr>
<td>Processed event tracking</td>
<td>Multiple event types, need audit trail</td>
<td>Medium</td>
<td>High</td>
</tr>
<tr>
<td>Stream position tracking</td>
<td>Single-stream projections</td>
<td>Medium</td>
<td>Medium</td>
</tr>
<tr>
<td>Upsert</td>
<td>Creating or updating projections</td>
<td>Low</td>
<td>High</td>
</tr>
<tr>
<td>Status flags</td>
<td>External side effects</td>
<td>Medium</td>
<td>High</td>
</tr>
</tbody>
</table>
<p>The principle: <strong>every event handler must produce the same result whether it
processes an event once or multiple times. Prefer naturally idempotent
operations. When that's not possible, deduplicate explicitly. The handler,
not the framework, is the primary defense against duplicate events.</strong></p>
<hr />
<div class="admonition tip">
<p class="admonition-title">Related reading</p>
<p><strong>Concepts:</strong></p>
<ul>
<li><a href="../../concepts/building-blocks/event-handlers/">Event Handlers</a>  How event handlers consume and process events.</li>
</ul>
<p><strong>Guides:</strong></p>
<ul>
<li><a href="../../guides/consume-state/event-handlers/">Event Handlers</a>  Defining handlers, configuration, and error handling.</li>
</ul>
</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../design-events-for-consumers/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Design Events for Consumers">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Design Events for Consumers
              </div>
            </div>
          </a>
        
        
          
          <a href="../event-versioning-and-evolution/" class="md-footer__link md-footer__link--next" aria-label="Next: Event Versioning and Evolution">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Event Versioning and Evolution
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019 - 2026 Subhash Bhushan
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "navigation.footer", "navigation.indexes", "navigation.sections", "navigation.expand", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.suggest", "toc.follow"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
        <script src="../../assets/external/unpkg.com/mermaid@10/dist/mermaid.min.js"></script>
      
        <script src="../../javascripts/mermaid-init.js"></script>
      
    
  </body>
</html>